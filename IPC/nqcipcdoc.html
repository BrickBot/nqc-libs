<script language="JavaScript">var PUpage="76001067"; var PUprop="geocities"; </script><script language="JavaScript" src="http://www.geocities.com/js_source/pu5geo.js"></script><script language="JavaScript"> var thGetOv="http://themis.geocities.yahoo.com/themis/h.php"; var thCanURL="http://us.geocities.com/connorbd/nqcipc/nqcipcdoc.html"; var thSpaceId="76001067"; var thIP="24.154.27.80"; var thTs="1151763774"; var thCs="d8a65e76c7ac173f70d60b43d6996967";</script><noscript><link rel="stylesheet" href="http://themis.geocities.yahoo.com/jsoff.css?thIP=24.154.27.80&thTs=1151763774"></noscript><script language="JavaScript" src="http://us.geocities.com/js_source/geovck08.js"></script>
<!-- text above generated by server. PLEASE REMOVE -->
<html>
<title>NQCIPC Documentation</title>

<h1>NQCIPC -- Simple Interprocess Communication for Lego Mindstorms and NQC</h1><p>

<i><a href="mailto:connorbd@yahoo.com">Brian Connors</a><br>
posted: 9 October 1999<br>last updated: 16 October 1999</i>

<hr>
<h3>1 Introduction</h3><p>

This package is a very simple implementation of semaphores and intertask messages for Lego Mindstorms designed for use with the NQC package. It is designed to provide explicit notations for intertask communication within RCX programs. What it doesn't do is operate between separate programs on one RCX; though the RCX firmware seems to be preemptively multitasking within programs, it runs only one program at once and the concept is therefore moot. It also does not provide an external (i.e. infrared) messaging API; IR messaging works somewhat differently than the design laid out here, though I'm not ruling out adding it later on.<p>

This package also doesn't do
<ul>
<li>sockets
<li>pipes (trivially emulated using messages anyway)
<li>anything resembling SysV IPC (too complicated)
</ul>

<h4>Legalities</h4><p>
In accordance with the prevailing practice in the MindStorms developer community, NQCIPC is (c)1999 Brian Connors, made available under the terms of the <a href="http://www.mozilla.org">Mozilla Public License</a>. I would also appreciate recieving a free copy of anything that you use my code in.<p>

Neither the author nor this software is associated with <a href="http://www.lego.com">Lego Group</a>, so don't go crying to them if this code doesn't work. They've never heard of me anyway. Equally, <a href="http://www.enteract.com/~dbaum">Dave Baum</a> wrote a pretty good programming language given what he had to work with, but NQCIPC isn't part of his package, so don't tell him that my stuff doesn't work.<p>

This is a simple package to do a simple job. I don't guarantee that it's good for anything in particular, so you use it at your own risk. Remember that whatever you may think it's good for, Mindstorms is intended as a toy, so use some common sense when you're playing with my code.<p>

<h3>2 The NQCIPC Package</h3><p>

The NQCIPC package consists of the following files:<p>
<ul>
<li>This document (nqcipcdoc.html)
<li><a href="rcxsem.txt">rcxsem.nqh</a> -- the semaphore macros
<li><a href="rcxmsg.txt">rcxmsg.nqh</a> -- the internal messaging macros
<li><a href="readme.txt">README</a> -- A readme file describing the current release in detail
</ul>

The home page for the package is at <a href="http://www.geocities.com/ResearchTriangle/Station/2266/nqcipc/nqcipcdoc.html">2266 Research Triangle</a>, my personal webpage. It's at GeoCities, so prepare to be bothered a bit. <p>

<h4>2.1 System Requirements</h4><p>

NQCIPC requires the use of David Baum's <a href="http://www.enteract.com/~dbaum/lego/nqc">NQC compiler</a> (version 2.0 or later), and can be used with Lego's <a href="http://www.legomindstorms.com">Mindstorms</a> and Cybermaster robotics products. It is intended for use with the standard Lego firmware, though I wouldn't mind seeing someone port the API to LegOS. <p>

Note that NQC does not support Lego's standalone Mindstorms Robotics Discovery Kit or Star Wars Droid Developer kit; though it is theoretically possible for a computer to communicate with the former, both are marketed as self-contained toys at present and details of their internal systems ("Scout" and "MicroScout") remain unpublished.

<h4>2.2 Bugs</h4><p>

As I write, I don't actually have an RCX of my own yet, but they're very simple macros (based on canned code), so I don't expect bug problems. If you do have any, you can contact me at <a href="mailto:connorbd@yahoo.com">connorbd@yahoo.com</a> and let me know what the problem is. Include the filename and version number (defined under SEMVER and MSGVER for semaphores and messages respectively) and a fix if you have it.

<h3>3 Semaphores -- <a href="rcxsem.txt">rcxsem.nqh</a></h3><p>

This file contains three macros for handling semaphores. A semaphore is like a "talking stick": it's a variable that several tasks have access to that lets them know not to all talk at once. It's useful for synchronizing several operations; for example, perhaps multiple tasks need access to the motors. If two different tasks try to execute movement instructions at the same time, they might wind up causing the robot to do lots of random things (or maybe nothing at all); likewise, in a regular computer program, this sort of collision might cause a file to be scrambled or a pointer to be redirected into the void, causing core dumps and other unpleasantness. These functions implement basic semaphore semantics.<p>

For readability, <i>rcxsem.nqh</i> allows you to define a variable of type <code>sem</code>. This is not enforced by the compiler, but it may be helpful for writing readable code.<p>

<h4>3.1 sem_clear</h4><p>

<b>Syntax:</b>
<pre>
	sem_clear(s);
</pre>

<code>sem_clear()</code> takes one argument, a semaphore variable named s, and clears it. It is recommended that you don't use this macro outside your <code>main</code> task, as it could create confusion.<p>

<h4>3.2 sem_acquire</h4><p>

<b>Syntax:</b>
<pre>
	sem_acquire(s);
</pre>

<code>sem_acquire()</code> waits for semaphore s to clear, then takes command of it. <p>

<h4>3.3 sem_release</h4><p>

<b>Syntax:</b>
<pre>
	sem_release(s);
</pre>

<code>sem_release()</code> relinquishes control of semaphore s.<p>

<h4>3.4 SSET/SCLEAR</h4><p>

The <code>SSET</code> and <code>SCLEAR</code> constants allow you to check the current status of a semaphore variable:

<pre>
	sem s;
	...
	if (s == SSET) {
		//do something appropriate to a set semaphore
	}
</pre>

In the current implementation, <code>SSET = 1</code> and <code>SCLEAR = 0</code>. <p>

<h3>4 Internal Messages -- <a href="rcxmsg.txt">rcxmsg.nqh</a></h3><p>

NQC contains functions that handle messages over the IR link (to the controlling computer or to other RCXen), but none that allow tasks to communicate with each other. Given the architecture of the RCX firmware, any interrupt-driven design is impossible, but a simple drop-box algorithm is trivially implemented in a manner much like the semaphore implementation. <p>

The messaging system has two notable limitations: the only data that can be passed are standard NQC integers, since NQC doesn't support strings or any other data type; and all message buffers are considered shared space, so all <code>msg_send()</code> operations are technically broadcasts. It is recommended that if targeted messages are needed, multiple buffers be set aside for the purpose.<p>

<code>rcxmsg.h</code> defines a datatype <code>msg</code> which behaves exactly as the <code>sem</code> type does. It is optional, but useful.<p>

<h4>4.1 msg_clear</h4><p>

<b>Syntax:</b>
<pre>
	msg_clear(buf);
</pre>

<code>msg_clear()</code> sets the contents of <code>buf</code> to 0. For the most part, you should avoid using <code>msg_clear()</code> in any routine except task main().<p>

<h4>4.2 msg_send</h4><p>

<b>Syntax:</b>
<pre>
	msg_send(buf,msg);
</pre>

<code>msg_send()</code> sets the contents of <code>buf</code> to <code>msg</code>.<p>

<h4>4.3 msg_await</h4><p>

<b>Syntax:</b>
<pre>
	msg_await(buf,val);
</pre>

<code>msg_await()</code> blocks (as with <code>sem_acquire()</code> above) until the value in <code>buf</code> is equal to <code>val</code>, then continues.<p>

<h4>4.4 msg_read</h4><p>

<b>Syntax:</b>
<pre>
	msg_read(buf,v);
</pre>

<code>msg_read()</code> copies the contents of <code>buf</code> into variable <code>v</code>.<p>

<h4>4.5 msg_biff</h4><p>

<b>Syntax:</b>
<pre>
	msg_biff(buf);
</pre>

<code>msg_biff()</code> returns true if there is a message (i.e. nonzero value) in <code>buf</code>. It's named for the BSD UNIX mail-alert program, in case you didn't know.<p>

<h3>5 Further Information</h3><p>

<h4>5.1 How To Get NQCIPC</h4><p>

Due to limitations in GeoCities' file handling, you have to download NQCIPC piece by piece. The following are the files you need:<p>

<ul>
<li><a href="nqcipcdoc.html">This file</a>, the HTML docs.
<li><a href="rcxsem.txt">rcxsem.txt</a> and <a href="rcxmsg.txt">rcxmsg.txt</a>. Download these as text files and rename with an .nqh extension.
<li><a href="readme.txt">The README file</a>.
</ul>

If you want the latest version, the home page is at <a href="http://www.geocities.com/ResearchTriangle/Station/2266/nqcipc/nqcipcdoc.html">http://www.geocities.com/ResearchTriangle/Station/2266/nqcipc/nqcipcdoc.html</a>. If you prefer a .tar.gz format file or wish to include NQCIPC in a separate product, contact me and I'll email it to you.

<h4>5.2 Links and Downloads</h4><p>

The following are some useful Lego Mindstorms links that relate more or less directly to this software and its uses. <p>
<ul>
<li>The <a href="http://www.legomindstorms.com"</a>Official Lego Mindstorms Page</a> at Lego. Don't expect to see links to this page from there, though; this stuff is pretty unofficial. Related products are Lego Dacta Robolab (available through <a href="http://www.pitsco.com">Pitsco</a>), a multiplatform educational version of Mindstorms; and Lego Technic Cybermaster, a slightly more primitive but very similar system available only in Europe (and based on RF instead of infrared; I don't know if this is an FCC issue or simply marketing). I don't have web links for those at this time.
<li><a href="http://www.enteract.com/~dbaum/lego">Dave Baum's Lego Page</a>, home site for the <a href="http://www.enteract.com/~dbaum/lego/nqc">Not Quite C</a> programming language that this was written to work with and also the best choice for doing Mindstorms programming on the Mac or Linux platforms. 
<li><a href="http://www.crynwr.com/lego-robotics">The Lego Robotics page</a> -- probably the most important Mindstorms/Cybermaster link farm on the net. It contains links to everything of interest on Lego's robotics products, including technical specs, project pages, and even replacement firmware (such as LegOS). 
<li><a href="http://graphics.stanford.edu/~kekoa/rcx">Kekoa Proudfoot's RCX Internals Page</a> -- home to as thorough a reverse-engineering as possible of the RCX computer that controls the standard Mindstorms. 
<li><a href="http://www.ora.com">O'Reilly and Associates</a> -- Famed the world over for their software references with the animals on the cover, O'Reilly publishes a fairly comprehensive guide to Mindstorms programming and design. Not available as I write this, I've seen a preprint and it's definitely a must-have for Mindstorms hackers.
</ul>

<h3>6 Conclusion</h3><p>

The standard RCX architecture is a bit strange and limited in places, but it's good enough to get the job done. NQCIPC simply extends the package a bit to make it a little more professional, and it's simple enough to give a beginning programmer an education in multitasking. <p>

This (10/9/99) is the first release of this package, and as yet it's untested (since I have the NQC docs but no Mindstorms set of my own). I'm willing to take suggestions and contributions (especially example code); just email them to me at <a href="mailto:connorbd@yahoo.com">connorbd@yahoo.com</a> and I'll put them in if I like them. Finally, if you like this stuff, send me an email and tell me what you're doing with it.<p>

Enjoy!<p>

<i>/Brian</i>
<hr>
Click <a href="http://www.geocities.com/ResearchTriangle/Station/2266">here</a> to go to my homepage, 2266 Research Triangle.

<!-- following code added by server. PLEASE REMOVE -->
<link href="http://us.geocities.com/js_source/div.css" rel="stylesheet" type="text/css"><script language="JavaScript" src="http://us.geocities.com/js_source/div03.js"></script>
<!-- preceding code added by server. PLEASE REMOVE --><!-- text below generated by server. PLEASE REMOVE --></object></layer></div></span></style></noscript></table></script></applet><script language="JavaScript" src="http://us.i1.yimg.com/us.yimg.com/i/mc/mc.js"></script><script language="JavaScript" src="http://geocities.com/js_source/geov2.js"></script><script language="javascript">geovisit();</script><noscript><img src="http://visit.geocities.yahoo.com/visit.gif?us1151763774" alt="setstats" border="0" width="1" height="1"></noscript>
<IMG SRC="http://geo.yahoo.com/serv?s=76001067&t=1151763774&f=us-w85" ALT=1 WIDTH=1 HEIGHT=1>
